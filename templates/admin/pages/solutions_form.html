{{define "content"}}
<div class="flex h-screen" style="font-family: 'JetBrains Mono', monospace;">
    {{template "admin-sidebar" .}}
    <div class="flex-1 overflow-auto p-8 bg-gray-50">
        <!-- Header -->
        <div class="mb-6">
            <a href="/admin/solutions" class="text-sm font-bold uppercase text-blue-600 hover:text-blue-800 border-b-2 border-blue-600">&larr; Back to Solutions</a>
            <h1 class="text-2xl font-bold uppercase tracking-tight mt-2">{{.Title}}</h1>
        </div>

        <form action="{{.FormAction}}" method="POST" class="max-w-4xl space-y-4" id="solution-form">

            <!-- Section 1: Basic Info (open) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900">
                    <span>Basic Information</span>
                    <span class="material-symbols-outlined section-chevron transition-transform">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">
                                Title *
                                <span class="inline-block ml-1 cursor-help text-gray-400" title="Solution name as displayed on the site.">ⓘ</span>
                            </label>
                            <input type="text" name="title" value="{{if .Item}}{{.Item.Title}}{{end}}" required
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">
                                Slug *
                                <span class="inline-block ml-1 cursor-help text-gray-400" title="URL-friendly version of the name. Auto-generated but editable.">ⓘ</span>
                            </label>
                            <input type="text" name="slug" value="{{if .Item}}{{.Item.Slug}}{{end}}" required
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">
                                Icon (Material Symbol) *
                                <span class="inline-block ml-1 cursor-help text-gray-400" title="Which industry this solution serves.">ⓘ</span>
                            </label>
                            <input type="text" name="icon" value="{{if .Item}}{{.Item.Icon}}{{end}}" required placeholder="e.g. school"
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Status</label>
                            <select name="is_published"
                                    class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    style="font-family: 'JetBrains Mono', monospace;">
                                <option value="0" {{if .Item}}{{if not .Item.IsPublished.Bool}}selected{{end}}{{end}}>Draft</option>
                                <option value="1" {{if .Item}}{{if .Item.IsPublished.Bool}}selected{{end}}{{end}}>Published</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">
                            Short Description *
                            <span class="inline-block ml-1 cursor-help text-gray-400" title="1-2 sentence summary shown on solution cards.">ⓘ</span>
                        </label>
                        <textarea name="short_description" required rows="2"
                                  class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  style="font-family: 'JetBrains Mono', monospace;">{{if .Item}}{{.Item.ShortDescription}}{{end}}</textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Display Order</label>
                            <input type="number" name="display_order" value="{{if .Item}}{{.Item.DisplayOrder.Int64}}{{else}}0{{end}}"
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Reference Code</label>
                            <input type="text" name="reference_code" value="{{if .Item}}{{.Item.ReferenceCode.String}}{{end}}" placeholder="e.g. EDU-2026.01"
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Content (open) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900">
                    <span>Content</span>
                    <span class="material-symbols-outlined section-chevron transition-transform">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">
                            Full Description
                            <span class="inline-block ml-1 cursor-help text-gray-400" title="Detailed description of the solution, including how it works and benefits.">ⓘ</span>
                        </label>
                        <input id="overview-input" type="hidden" name="overview_content"
                               value="{{if .Item}}{{if .Item.OverviewContent.Valid}}{{.Item.OverviewContent.String}}{{end}}{{end}}">
                        <trix-editor input="overview-input"
                                     class="border-2 border-black text-sm min-h-[150px] focus:outline-none focus:ring-2 focus:ring-blue-500"
                                     style="font-family: 'JetBrains Mono', monospace;"></trix-editor>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">
                            Hero Image URL
                            <span class="inline-block ml-1 cursor-help text-gray-400" title="Main banner image for the solution page. Recommended 1200x600.">ⓘ</span>
                        </label>
                        <input type="text" name="hero_image_url" value="{{if .Item}}{{.Item.HeroImageUrl.String}}{{end}}"
                               class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               style="font-family: 'JetBrains Mono', monospace;"
                               placeholder="https://...">
                        {{if .Item}}{{if .Item.HeroImageUrl.Valid}}
                        <div class="mt-2">
                            <img src="{{.Item.HeroImageUrl.String}}" alt="Hero preview" class="w-48 h-24 object-cover border-2 border-black">
                        </div>
                        {{end}}{{end}}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Hero Title</label>
                            <input type="text" name="hero_title" value="{{if .Item}}{{.Item.HeroTitle.String}}{{end}}"
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Hero Description</label>
                            <textarea name="hero_description" rows="2"
                                      class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      style="font-family: 'JetBrains Mono', monospace;">{{if .Item}}{{.Item.HeroDescription.String}}{{end}}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: SEO (collapsed) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section data-collapsed>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900">
                    <span>SEO</span>
                    <span class="material-symbols-outlined section-chevron transition-transform rotate-[-90deg]">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Meta Title</label>
                        <input type="text" name="meta_title" maxlength="70"
                               value="{{if .Item}}{{.Item.MetaTitle}}{{end}}"
                               class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               style="font-family: 'JetBrains Mono', monospace;"
                               oninput="updateCharCount(this, 'meta-title-count', 70)">
                        <p class="text-xs text-gray-500 mt-1"><span id="meta-title-count">0</span>/70 characters</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Meta Description</label>
                        <textarea name="meta_description" maxlength="160" rows="2"
                                  class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  style="font-family: 'JetBrains Mono', monospace;"
                                  oninput="updateCharCount(this, 'meta-desc-count', 160)">{{if .Item}}{{.Item.MetaDescription.String}}{{end}}</textarea>
                        <p class="text-xs text-gray-500 mt-1"><span id="meta-desc-count">0</span>/160 characters</p>
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="pt-2 flex gap-3 items-center">
                <button type="submit"
                        class="bg-blue-600 text-white px-8 py-3 text-sm font-bold uppercase border-2 border-black hover:translate-x-[1px] hover:translate-y-[1px]"
                        style="box-shadow: 4px 4px 0px #000;">
                    {{if .Item}}Update Solution{{else}}Create Solution{{end}}
                </button>
                {{if .Item}}
                <a href="/solutions/{{.Item.Slug}}?preview=true" target="_blank"
                   title="Preview how this content will look on the public site."
                   class="bg-white text-black px-6 py-3 text-sm font-bold uppercase border-2 border-black hover:translate-x-[1px] hover:translate-y-[1px] inline-flex items-center gap-2"
                   style="box-shadow: 4px 4px 0px #000; text-decoration: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Preview
                </a>
                {{end}}
            </div>
        </form>

        {{if .Item}}
        <!-- Solution Details (HTMX sub-tabs) -->
        <div class="mt-8 max-w-4xl">
            <h2 class="text-lg font-bold uppercase mb-4">Solution Details</h2>
            <div class="border-b-2 border-black mb-0">
                <nav class="flex" id="detail-tabs">
                    <button class="px-4 py-2 text-sm font-bold uppercase bg-black text-white border-2 border-black border-b-0"
                            hx-get="/admin/solutions/{{.Item.ID}}/challenges-tab"
                            hx-target="#detail-content"
                            hx-swap="innerHTML"
                            onclick="setActiveTab(this)">Challenges</button>
                    <button class="px-4 py-2 text-sm font-bold uppercase bg-white text-black border-2 border-black border-b-0 border-l-0 hover:bg-gray-100"
                            hx-get="/admin/solutions/{{.Item.ID}}/products-tab"
                            hx-target="#detail-content"
                            hx-swap="innerHTML"
                            onclick="setActiveTab(this)">Products</button>
                    <button class="px-4 py-2 text-sm font-bold uppercase bg-white text-black border-2 border-black border-b-0 border-l-0 hover:bg-gray-100"
                            hx-get="/admin/solutions/{{.Item.ID}}/stats-tab"
                            hx-target="#detail-content"
                            hx-swap="innerHTML"
                            onclick="setActiveTab(this)">Stats</button>
                    <button class="px-4 py-2 text-sm font-bold uppercase bg-white text-black border-2 border-black border-b-0 border-l-0 hover:bg-gray-100"
                            hx-get="/admin/solutions/{{.Item.ID}}/ctas-tab"
                            hx-target="#detail-content"
                            hx-swap="innerHTML"
                            onclick="setActiveTab(this)">CTAs</button>
                </nav>
            </div>
            <div id="detail-content"
                 class="bg-white border-2 border-black border-t-0 p-5"
                 hx-get="/admin/solutions/{{.Item.ID}}/challenges-tab"
                 hx-trigger="load"
                 hx-swap="innerHTML"
                 style="box-shadow: 4px 4px 0px #000;">
                <p class="text-gray-500 text-sm">Loading...</p>
            </div>
        </div>
        {{end}}
    </div>
</div>

<script>
function toggleSection(btn) {
    var body = btn.nextElementSibling;
    var chevron = btn.querySelector('.section-chevron');
    if (body.classList.contains('hidden')) {
        body.classList.remove('hidden');
        chevron.style.transform = 'rotate(0deg)';
    } else {
        body.classList.add('hidden');
        chevron.style.transform = 'rotate(-90deg)';
    }
}

function updateCharCount(input, countId, max) {
    var el = document.getElementById(countId);
    if (el) el.textContent = input.value.length;
}

function setActiveTab(el) {
    document.querySelectorAll('#detail-tabs button').forEach(function(btn) {
        btn.className = 'px-4 py-2 text-sm font-bold uppercase bg-white text-black border-2 border-black border-b-0 border-l-0 hover:bg-gray-100';
    });
    el.className = 'px-4 py-2 text-sm font-bold uppercase bg-black text-white border-2 border-black border-b-0';
}

// Auto-slug generation
(function() {
    var titleInput = document.querySelector('input[name="title"]');
    var slugInput = document.querySelector('input[name="slug"]');
    if (titleInput && slugInput) {
        titleInput.addEventListener('blur', function() {
            if (slugInput.value === '') {
                slugInput.value = titleInput.value.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            }
        });
    }
})();

// Init char counts
(function() {
    var mt = document.querySelector('input[name="meta_title"]');
    var md = document.querySelector('textarea[name="meta_description"]');
    if (mt) updateCharCount(mt, 'meta-title-count', 70);
    if (md) updateCharCount(md, 'meta-desc-count', 160);
})();
</script>
{{end}}
