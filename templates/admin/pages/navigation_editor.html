{{define "content"}}
<div class="flex h-screen">
    {{template "admin-sidebar" .}}
    <div class="flex-1 overflow-auto p-8">
        <div class="max-w-6xl">
            <!-- Page Header -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <a href="/admin/navigation" class="text-sm font-bold uppercase text-gray-600 hover:text-black" style="font-family: 'JetBrains Mono', monospace;">&larr; All Menus</a>
                    <h1 class="text-3xl font-bold uppercase tracking-tight mt-1" style="font-family: 'JetBrains Mono', monospace;">{{.Menu.Name}}</h1>
                </div>
            </div>

            {{if .Saved}}
            <div class="bg-green-100 border-2 border-black text-green-900 px-4 py-3 mb-6 font-bold uppercase text-sm" style="font-family: 'JetBrains Mono', monospace; box-shadow: 4px 4px 0px #000;">
                &#10003; Menu updated successfully.
            </div>
            {{end}}

            <div class="flex gap-6">
                <!-- Left Column: Add Items -->
                <div class="w-1/3 space-y-6">
                    <!-- Menu Settings -->
                    <div class="bg-white border-2 border-black p-5 space-y-4" style="box-shadow: 4px 4px 0px #000;">
                        <h2 class="text-sm font-bold uppercase border-b-2 border-black pb-2" style="font-family: 'JetBrains Mono', monospace;">Menu Settings</h2>
                        <form method="POST" action="/admin/navigation/{{.Menu.ID}}/settings" class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Menu Name</label>
                                    <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Internal name for this menu (e.g., 'Main Header Nav').">info</span>
                                </div>
                                <input type="text" name="name" value="{{.Menu.Name}}" class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Location</label>
                                    <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Where this menu appears on the site.">info</span>
                                </div>
                                <select name="location" class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
                                    <option value="header" {{if eq .Menu.Location "header"}}selected{{end}}>Header</option>
                                    <option value="footer" {{if eq .Menu.Location "footer"}}selected{{end}}>Footer</option>
                                    <option value="footer_legal" {{if eq .Menu.Location "footer_legal"}}selected{{end}}>Footer Legal</option>
                                    <option value="mobile" {{if eq .Menu.Location "mobile"}}selected{{end}}>Mobile</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full px-4 py-2 border-2 border-black bg-black text-white text-xs font-bold uppercase hover:translate-x-[1px] hover:translate-y-[1px] transition-transform" style="font-family: 'JetBrains Mono', monospace; box-shadow: 3px 3px 0px #000;" onmouseenter="this.style.boxShadow='1px 1px 0px #000'" onmouseleave="this.style.boxShadow='3px 3px 0px #000'">
                                Update Settings
                            </button>
                        </form>
                    </div>

                    <!-- Add Page Link -->
                    <div class="bg-white border-2 border-black p-5 space-y-4" style="box-shadow: 4px 4px 0px #000;">
                        <h2 class="text-sm font-bold uppercase border-b-2 border-black pb-2" style="font-family: 'JetBrains Mono', monospace;">
                            <span class="inline-block w-3 h-3 bg-blue-500 border border-black mr-2" style="vertical-align: middle;"></span>
                            Add Page Link
                        </h2>
                        <form method="POST" action="/admin/navigation/{{.Menu.ID}}/items" class="space-y-3">
                            <input type="hidden" name="link_type" value="page">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Page</label>
                                    <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Link to an existing page on your site.">info</span>
                                </div>
                                <select name="page_identifier" class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
                                    {{range .PageOptions}}
                                    <option value="{{.}}">{{.}}</option>
                                    {{end}}
                                </select>
                            </div>
                            <button type="submit" class="w-full px-4 py-2 border-2 border-black bg-blue-50 text-xs font-bold uppercase hover:bg-blue-100" style="font-family: 'JetBrains Mono', monospace; box-shadow: 3px 3px 0px #000;" onmouseenter="this.style.boxShadow='1px 1px 0px #000'" onmouseleave="this.style.boxShadow='3px 3px 0px #000'">
                                Add to Menu
                            </button>
                        </form>
                    </div>

                    <!-- Add Custom Link -->
                    <div class="bg-white border-2 border-black p-5 space-y-4" style="box-shadow: 4px 4px 0px #000;">
                        <h2 class="text-sm font-bold uppercase border-b-2 border-black pb-2" style="font-family: 'JetBrains Mono', monospace;">
                            <span class="inline-block w-3 h-3 bg-green-500 border border-black mr-2" style="vertical-align: middle;"></span>
                            Add Custom Link
                        </h2>
                        <form method="POST" action="/admin/navigation/{{.Menu.ID}}/items" class="space-y-3">
                            <input type="hidden" name="link_type" value="custom">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Label</label>
                                    <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Link to any URL, internal or external.">info</span>
                                </div>
                                <input type="text" name="label" placeholder="Link text" required class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-black uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">URL</label>
                                <input type="text" name="url" placeholder="https://example.com" required class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 border-2 border-black bg-green-50 text-xs font-bold uppercase hover:bg-green-100" style="font-family: 'JetBrains Mono', monospace; box-shadow: 3px 3px 0px #000;" onmouseenter="this.style.boxShadow='1px 1px 0px #000'" onmouseleave="this.style.boxShadow='3px 3px 0px #000'">
                                Add to Menu
                            </button>
                        </form>
                    </div>

                    <!-- Add Dropdown -->
                    <div class="bg-white border-2 border-black p-5 space-y-4" style="box-shadow: 4px 4px 0px #000;">
                        <h2 class="text-sm font-bold uppercase border-b-2 border-black pb-2" style="font-family: 'JetBrains Mono', monospace;">
                            <span class="inline-block w-3 h-3 bg-purple-500 border border-black mr-2" style="vertical-align: middle;"></span>
                            Add Dropdown
                        </h2>
                        <form method="POST" action="/admin/navigation/{{.Menu.ID}}/items" class="space-y-3">
                            <input type="hidden" name="link_type" value="dropdown">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Name</label>
                                    <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Creates a dropdown menu with child links.">info</span>
                                </div>
                                <input type="text" name="label" placeholder="Dropdown name" required class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 border-2 border-black bg-purple-50 text-xs font-bold uppercase hover:bg-purple-100" style="font-family: 'JetBrains Mono', monospace; box-shadow: 3px 3px 0px #000;" onmouseenter="this.style.boxShadow='1px 1px 0px #000'" onmouseleave="this.style.boxShadow='3px 3px 0px #000'">
                                Add to Menu
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Right Column: Menu Structure -->
                <div class="w-2/3 space-y-6">
                    <div class="bg-white border-2 border-black p-5" style="box-shadow: 4px 4px 0px #000;">
                        <h2 class="text-sm font-bold uppercase border-b-2 border-black pb-2 mb-4" style="font-family: 'JetBrains Mono', monospace;">Menu Structure</h2>

                        {{if .Items}}
                        <div id="menu-items" class="space-y-2">
                            {{range .Items}}
                            <div class="menu-item border-2 border-black bg-white" data-id="{{.ID}}">
                                <div class="flex items-center gap-3 px-4 py-3">
                                    <span class="material-symbols-outlined text-gray-400 cursor-grab drag-handle" style="font-size: 18px;">drag_indicator</span>
                                    {{if eq .LinkType "page"}}
                                    <span class="inline-block px-2 py-0.5 border border-blue-600 bg-blue-50 text-blue-700 text-[10px] font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Page</span>
                                    {{else if eq .LinkType "custom"}}
                                    <span class="inline-block px-2 py-0.5 border border-green-600 bg-green-50 text-green-700 text-[10px] font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Custom</span>
                                    {{else if eq .LinkType "dropdown"}}
                                    <span class="inline-block px-2 py-0.5 border border-purple-600 bg-purple-50 text-purple-700 text-[10px] font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Dropdown</span>
                                    {{end}}
                                    <span class="text-sm font-bold flex-1" style="font-family: 'JetBrains Mono', monospace;">{{.Label}}</span>
                                    {{if .Url.Valid}}
                                    <span class="text-xs text-gray-500 truncate max-w-[200px]" style="font-family: 'JetBrains Mono', monospace;">{{.Url.String}}</span>
                                    {{end}}
                                    {{if and .IsActive.Valid (eq .IsActive.Int64 0)}}
                                    <span class="text-[10px] font-bold uppercase text-red-600 border border-red-300 px-1" style="font-family: 'JetBrains Mono', monospace;">Inactive</span>
                                    {{end}}
                                    <button onclick="openEditModal({{.ID}})" class="px-2 py-1 border-2 border-black bg-white text-xs font-bold uppercase hover:bg-gray-100" style="font-family: 'JetBrains Mono', monospace;">Edit</button>
                                    <button hx-delete="/admin/navigation/items/{{.ID}}" hx-confirm="Delete this item?" hx-target="closest .menu-item" hx-swap="outerHTML swap:0.3s" class="px-2 py-1 border-2 border-black bg-red-100 text-xs font-bold uppercase hover:bg-red-200" style="font-family: 'JetBrains Mono', monospace;">Delete</button>
                                </div>
                                {{if .Children}}
                                <div class="ml-8 border-l-4 border-gray-300 space-y-1 pb-2">
                                    {{range .Children}}
                                    <div class="menu-item flex items-center gap-3 px-4 py-2 border-b border-gray-100" data-id="{{.ID}}" data-parent="{{.ParentID.Int64}}">
                                        <span class="material-symbols-outlined text-gray-400 cursor-grab drag-handle" style="font-size: 16px;">drag_indicator</span>
                                        {{if eq .LinkType "page"}}
                                        <span class="inline-block px-2 py-0.5 border border-blue-600 bg-blue-50 text-blue-700 text-[10px] font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Page</span>
                                        {{else if eq .LinkType "custom"}}
                                        <span class="inline-block px-2 py-0.5 border border-green-600 bg-green-50 text-green-700 text-[10px] font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Custom</span>
                                        {{end}}
                                        <span class="text-sm font-bold flex-1" style="font-family: 'JetBrains Mono', monospace;">{{.Label}}</span>
                                        {{if .Url.Valid}}
                                        <span class="text-xs text-gray-500 truncate max-w-[150px]" style="font-family: 'JetBrains Mono', monospace;">{{.Url.String}}</span>
                                        {{end}}
                                        <button onclick="openEditModal({{.ID}})" class="px-2 py-1 border border-black bg-white text-xs font-bold uppercase hover:bg-gray-100" style="font-family: 'JetBrains Mono', monospace;">Edit</button>
                                        <button hx-delete="/admin/navigation/items/{{.ID}}" hx-confirm="Delete?" hx-target="closest .menu-item" hx-swap="outerHTML swap:0.3s" class="px-2 py-1 border border-black bg-red-100 text-xs font-bold uppercase hover:bg-red-200" style="font-family: 'JetBrains Mono', monospace;">Del</button>
                                    </div>
                                    {{end}}
                                </div>
                                {{end}}
                            </div>
                            {{end}}
                        </div>
                        {{else}}
                        <div class="py-8 text-center">
                            <span class="material-symbols-outlined text-4xl text-gray-300 mb-2">list</span>
                            <p class="text-sm text-gray-500" style="font-family: 'JetBrains Mono', monospace;">No items in this menu yet. Add items from the left panel.</p>
                        </div>
                        {{end}}
                    </div>

                    <!-- Preview Section -->
                    <div class="bg-white border-2 border-black p-5" style="box-shadow: 4px 4px 0px #000;">
                        <h2 class="text-sm font-bold uppercase border-b-2 border-black pb-2 mb-4" style="font-family: 'JetBrains Mono', monospace;">Navigation Preview</h2>
                        <div class="bg-gray-900 border-2 border-black p-4">
                            <div class="flex items-center gap-6">
                                {{range .Items}}
                                {{if and .IsActive.Valid (eq .IsActive.Int64 1)}}
                                {{if eq .LinkType "dropdown"}}
                                <div class="relative group">
                                    <span class="text-white text-sm font-bold cursor-pointer hover:text-blue-300 flex items-center gap-1" style="font-family: 'JetBrains Mono', monospace;">
                                        {{.Label}}
                                        <span class="material-symbols-outlined text-sm">expand_more</span>
                                    </span>
                                </div>
                                {{else}}
                                <a href="#" class="text-white text-sm font-bold hover:text-blue-300" style="font-family: 'JetBrains Mono', monospace;">{{.Label}}</a>
                                {{end}}
                                {{end}}
                                {{end}}
                                {{if not .Items}}
                                <span class="text-gray-500 text-sm italic" style="font-family: 'JetBrains Mono', monospace;">Empty menu - add items to preview</span>
                                {{end}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="edit-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeEditModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white border-2 border-black p-6 space-y-4" style="box-shadow: 8px 8px 0px #000;">
        <div class="flex items-center justify-between border-b-2 border-black pb-3">
            <h3 class="text-lg font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Edit Menu Item</h3>
            <button onclick="closeEditModal()" class="border-2 border-black px-2 py-1 bg-white hover:bg-gray-100 text-sm font-bold" style="font-family: 'JetBrains Mono', monospace;">&#10005;</button>
        </div>
        <form id="edit-form" method="POST" class="space-y-4">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Label</label>
                    <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Display text for this menu link.">info</span>
                </div>
                <input type="text" name="label" id="edit-label" class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
            </div>
            <div>
                <label class="block text-xs font-bold text-black uppercase mb-2" style="font-family: 'JetBrains Mono', monospace;">Link Type</label>
                <div class="flex gap-3">
                    <label class="flex-1 cursor-pointer border-2 border-black p-3 text-center link-type-card" data-type="page">
                        <input type="radio" name="link_type" value="page" class="sr-only" onchange="updateEditType('page')">
                        <div class="text-xs font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Page</div>
                    </label>
                    <label class="flex-1 cursor-pointer border-2 border-black p-3 text-center link-type-card" data-type="custom">
                        <input type="radio" name="link_type" value="custom" class="sr-only" onchange="updateEditType('custom')">
                        <div class="text-xs font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Custom</div>
                    </label>
                    <label class="flex-1 cursor-pointer border-2 border-black p-3 text-center link-type-card" data-type="dropdown">
                        <input type="radio" name="link_type" value="dropdown" class="sr-only" onchange="updateEditType('dropdown')">
                        <div class="text-xs font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Dropdown</div>
                    </label>
                </div>
            </div>
            <div id="edit-page-field">
                <label class="block text-xs font-bold text-black uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">Page</label>
                <select name="page_identifier" id="edit-page" class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
                    {{range .PageOptions}}
                    <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
            </div>
            <div id="edit-url-field">
                <label class="block text-xs font-bold text-black uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">URL</label>
                <input type="text" name="url" id="edit-url" placeholder="https://example.com" class="w-full border-2 border-black px-3 py-2 text-sm bg-white focus:outline-none focus:border-blue-600" style="font-family: 'JetBrains Mono', monospace;">
            </div>
            <div class="flex gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Open in New Tab</label>
                        <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Choose 'New Tab' for external links.">info</span>
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="open_new_tab" id="edit-newtab" class="border-2 border-black w-5 h-5">
                        <span class="text-xs font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">New Tab</span>
                    </label>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <label class="block text-xs font-bold text-black uppercase" style="font-family: 'JetBrains Mono', monospace;">Active</label>
                        <span class="material-symbols-outlined text-gray-400 cursor-help" style="font-size: 14px;" title="Inactive items are hidden from the navigation.">info</span>
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="is_active" id="edit-active" class="border-2 border-black w-5 h-5">
                        <span class="text-xs font-bold uppercase" style="font-family: 'JetBrains Mono', monospace;">Active</span>
                    </label>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" onclick="closeEditModal()" class="px-4 py-2 border-2 border-black bg-white text-xs font-bold uppercase hover:bg-gray-100" style="font-family: 'JetBrains Mono', monospace;">Cancel</button>
                <button type="submit" class="px-6 py-2 border-2 border-black bg-black text-white text-xs font-bold uppercase hover:translate-x-[1px] hover:translate-y-[1px] transition-transform" style="font-family: 'JetBrains Mono', monospace; box-shadow: 3px 3px 0px #000;" onmouseenter="this.style.boxShadow='1px 1px 0px #000'" onmouseleave="this.style.boxShadow='3px 3px 0px #000'">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Store all items data for edit modal
var allItems = {
    {{range .AllItems}}
    {{.ID}}: {
        id: {{.ID}},
        label: "{{.Label}}",
        linkType: "{{.LinkType}}",
        url: "{{.Url.String}}",
        pageIdentifier: "{{.PageIdentifier.String}}",
        openNewTab: {{if and .OpenNewTab.Valid (eq .OpenNewTab.Int64 1)}}true{{else}}false{{end}},
        isActive: {{if and .IsActive.Valid (eq .IsActive.Int64 1)}}true{{else}}false{{end}}
    },
    {{end}}
};

function openEditModal(id) {
    var item = allItems[id];
    if (!item) return;

    document.getElementById('edit-form').action = '/admin/navigation/items/' + id;
    document.getElementById('edit-label').value = item.label;
    document.getElementById('edit-url').value = item.url;
    document.getElementById('edit-newtab').checked = item.openNewTab;
    document.getElementById('edit-active').checked = item.isActive;

    // Set link type
    document.querySelectorAll('input[name="link_type"]').forEach(function(r) {
        r.checked = r.value === item.linkType;
    });
    updateEditType(item.linkType);

    // Set page identifier
    if (item.pageIdentifier) {
        document.getElementById('edit-page').value = item.pageIdentifier;
    }

    document.getElementById('edit-modal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
}

function updateEditType(type) {
    // Update card styling
    document.querySelectorAll('.link-type-card').forEach(function(card) {
        if (card.dataset.type === type) {
            card.classList.add('bg-black', 'text-white');
            card.classList.remove('bg-white', 'text-black');
        } else {
            card.classList.remove('bg-black', 'text-white');
            card.classList.add('bg-white', 'text-black');
        }
    });

    document.getElementById('edit-page-field').style.display = type === 'page' ? '' : 'none';
    document.getElementById('edit-url-field').style.display = type === 'custom' ? '' : 'none';
}
</script>
{{end}}
