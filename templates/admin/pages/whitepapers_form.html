{{define "content"}}
<div class="flex h-screen">
    {{template "admin-sidebar" .}}
    <div class="flex-1 overflow-auto p-8">
        <div class="mb-6">
            <a href="/admin/whitepapers" class="text-sm font-bold uppercase hover:underline" style="font-family: 'JetBrains Mono', monospace;">&larr; Back to Whitepapers</a>
            <h1 class="text-2xl font-bold mt-2 uppercase" style="font-family: 'JetBrains Mono', monospace;">{{.Title}}</h1>
        </div>
        <form method="POST" action="{{.FormAction}}" enctype="multipart/form-data" class="max-w-4xl space-y-6">

            <!-- Section 1: Basic Info (open) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900"
                        style="font-family: 'JetBrains Mono', monospace;">
                    <span>Basic Information</span>
                    <span class="material-symbols-outlined section-chevron transition-transform">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                                Title *
                                <span class="inline-block ml-1 cursor-help text-gray-400" title="Whitepaper title. Use a clear, benefit-driven title.">ⓘ</span>
                            </label>
                            <input type="text" name="title" value="{{if .Item}}{{.Item.Title}}{{end}}" required
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                                Slug *
                            </label>
                            <input type="text" name="slug" value="{{if .Item}}{{.Item.Slug}}{{end}}" required
                                   class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="font-family: 'JetBrains Mono', monospace;">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                                Topic *
                                <span class="inline-block ml-1 cursor-help text-gray-400" title="The subject category for this whitepaper.">ⓘ</span>
                            </label>
                            <select name="topic_id" required
                                    class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    style="font-family: 'JetBrains Mono', monospace;">
                                <option value="">Select Topic</option>
                                {{range .Topics}}
                                <option value="{{.ID}}" {{if and $.Item (eq $.Item.TopicID .ID)}}selected{{end}}>{{.Name}}</option>
                                {{end}}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">Status</label>
                            <div class="flex items-center gap-3 mt-2">
                                <label class="flex items-center gap-2 cursor-pointer" style="font-family: 'JetBrains Mono', monospace;">
                                    <input type="checkbox" name="is_published" value="on" {{if .Item}}{{if eq .Item.IsPublished 1}}checked{{end}}{{end}}
                                           class="w-4 h-4 border-2 border-black">
                                    <span class="text-sm font-bold uppercase">Published</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                            Published Date
                        </label>
                        <input type="date" name="published_date" value="{{if .Item}}{{.Item.PublishedDate}}{{end}}"
                               class="w-full md:w-1/2 border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               style="font-family: 'JetBrains Mono', monospace;">
                    </div>
                </div>
            </div>

            <!-- Section 2: Content (open) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900"
                        style="font-family: 'JetBrains Mono', monospace;">
                    <span>Content</span>
                    <span class="material-symbols-outlined section-chevron transition-transform">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                            Summary *
                            <span class="inline-block ml-1 cursor-help text-gray-400" title="Executive summary shown on the listing page. Convince readers to download.">ⓘ</span>
                        </label>
                        <textarea name="description" required rows="4"
                                  class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  style="font-family: 'JetBrains Mono', monospace;">{{if .Item}}{{.Item.Description}}{{end}}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                            PDF File
                            <span class="inline-block ml-1 cursor-help text-gray-400" title="Upload the whitepaper PDF file. This is what users download.">ⓘ</span>
                        </label>
                        <input type="file" name="pdf_file" accept=".pdf"
                               class="w-full text-sm border-2 border-black px-3 py-2"
                               style="font-family: 'JetBrains Mono', monospace;">
                        {{if .Item}}{{if .Item.PdfFilePath}}
                        <div class="mt-2 p-3 bg-gray-100 border-2 border-black text-sm" style="font-family: 'JetBrains Mono', monospace;">
                            <span class="font-bold">Current PDF:</span> {{.Item.PdfFilePath}}
                            {{if .Item.FileSizeBytes}}
                            <span class="ml-2 text-gray-600">({{.Item.FileSizeBytes}} bytes)</span>
                            {{end}}
                        </div>
                        {{end}}{{end}}
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">Page Count</label>
                        <input type="number" name="page_count" min="0" value="{{if .Item}}{{if .Item.PageCount.Valid}}{{.Item.PageCount.Int64}}{{end}}{{end}}"
                               class="w-full md:w-1/3 border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               style="font-family: 'JetBrains Mono', monospace;">
                    </div>
                </div>
            </div>

            <!-- Section 3: Landing Page (collapsed) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section data-collapsed>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900"
                        style="font-family: 'JetBrains Mono', monospace;">
                    <span>Landing Page</span>
                    <span class="material-symbols-outlined section-chevron transition-transform rotate-[-90deg]">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                            Cover Colors
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1" style="font-family: 'JetBrains Mono', monospace;">Color From</label>
                                <input type="color" name="cover_color_from" value="{{if .Item}}{{.Item.CoverColorFrom}}{{else}}#3B82F6{{end}}"
                                       class="w-full h-10 border-2 border-black cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1" style="font-family: 'JetBrains Mono', monospace;">Color To</label>
                                <input type="color" name="cover_color_to" value="{{if .Item}}{{.Item.CoverColorTo}}{{else}}#1E40AF{{end}}"
                                       class="w-full h-10 border-2 border-black cursor-pointer">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">
                            Key Takeaways
                            <span class="inline-block ml-1 cursor-help text-gray-400" title="Bullet-point benefits. Shown above the download button.">ⓘ</span>
                        </label>
                        <div id="learning-points">
                            {{if .LearningPoints}}
                            {{range .LearningPoints}}
                            <div class="flex items-center gap-2 mb-2 learning-point-row">
                                <input type="text" name="learning_points[]" value="{{.PointText}}"
                                       class="flex-1 border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       style="font-family: 'JetBrains Mono', monospace;">
                                <button type="button" onclick="this.parentElement.remove()"
                                        class="bg-white text-red-600 px-3 py-2 text-xs font-bold uppercase border-2 border-red-600 hover:bg-red-50"
                                        style="font-family: 'JetBrains Mono', monospace;">
                                    Remove
                                </button>
                            </div>
                            {{end}}
                            {{end}}
                        </div>
                        <button type="button" onclick="addLearningPoint()"
                                class="bg-white text-black px-3 py-1 text-xs font-bold uppercase border-2 border-black hover:bg-gray-100 mt-1"
                                style="box-shadow: 2px 2px 0px #000; font-family: 'JetBrains Mono', monospace;">
                            + Add Takeaway
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section 4: Gating (collapsed) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section data-collapsed>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900"
                        style="font-family: 'JetBrains Mono', monospace;">
                    <span>Gating</span>
                    <span class="material-symbols-outlined section-chevron transition-transform rotate-[-90deg]">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4 hidden">
                    <div>
                        <label class="flex items-center gap-3 cursor-pointer" style="font-family: 'JetBrains Mono', monospace;">
                            <input type="checkbox" name="require_form" value="on" class="w-4 h-4 border-2 border-black"
                                   title="If enabled, visitors must submit their email before downloading.">
                            <span class="text-sm font-bold uppercase">Require form submission to download</span>
                            <span class="inline-block ml-1 cursor-help text-gray-400" title="If enabled, visitors must submit their email before downloading.">ⓘ</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-2" style="font-family: 'JetBrains Mono', monospace;">Form Fields to Collect</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer" style="font-family: 'JetBrains Mono', monospace;">
                                <input type="checkbox" name="gate_fields[]" value="name" checked class="w-4 h-4 border-2 border-black">
                                <span class="text-sm">Name</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer" style="font-family: 'JetBrains Mono', monospace;">
                                <input type="checkbox" name="gate_fields[]" value="email" checked class="w-4 h-4 border-2 border-black">
                                <span class="text-sm">Email</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer" style="font-family: 'JetBrains Mono', monospace;">
                                <input type="checkbox" name="gate_fields[]" value="company" class="w-4 h-4 border-2 border-black">
                                <span class="text-sm">Company</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer" style="font-family: 'JetBrains Mono', monospace;">
                                <input type="checkbox" name="gate_fields[]" value="phone" class="w-4 h-4 border-2 border-black">
                                <span class="text-sm">Phone</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer" style="font-family: 'JetBrains Mono', monospace;">
                                <input type="checkbox" name="gate_fields[]" value="job_title" class="w-4 h-4 border-2 border-black">
                                <span class="text-sm">Job Title</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: SEO (collapsed) -->
            <div class="bg-white border-2 border-black" style="box-shadow: 4px 4px 0px #000;" data-section data-collapsed>
                <button type="button" onclick="toggleSection(this)"
                        class="w-full flex items-center justify-between px-5 py-3 bg-black text-white font-bold uppercase text-sm hover:bg-gray-900"
                        style="font-family: 'JetBrains Mono', monospace;">
                    <span>SEO</span>
                    <span class="material-symbols-outlined section-chevron transition-transform rotate-[-90deg]">expand_more</span>
                </button>
                <div class="section-body p-5 space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">Meta Title</label>
                        <input type="text" name="meta_title" value=""
                               class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               style="font-family: 'JetBrains Mono', monospace;">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="font-family: 'JetBrains Mono', monospace;">Meta Description</label>
                        <textarea name="meta_description" rows="3"
                                  class="w-full border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  style="font-family: 'JetBrains Mono', monospace;">{{if .Item}}{{if .Item.MetaDescription.Valid}}{{.Item.MetaDescription.String}}{{end}}{{end}}</textarea>
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="pt-2 flex gap-3 items-center">
                <button type="submit"
                        class="bg-blue-600 text-white px-8 py-3 text-sm font-bold uppercase border-2 border-black hover:translate-x-[1px] hover:translate-y-[1px]"
                        style="box-shadow: 4px 4px 0px #000; font-family: 'JetBrains Mono', monospace;">
                    {{if .Item}}Update Whitepaper{{else}}Create Whitepaper{{end}}
                </button>
                {{if .Item}}
                <a href="/whitepapers/{{.Item.Slug}}?preview=true" target="_blank"
                   title="Preview how this content will look on the public site."
                   class="bg-white text-black px-6 py-3 text-sm font-bold uppercase border-2 border-black hover:translate-x-[1px] hover:translate-y-[1px] inline-flex items-center gap-2"
                   style="box-shadow: 4px 4px 0px #000; text-decoration: none; font-family: 'JetBrains Mono', monospace;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Preview
                </a>
                {{end}}
            </div>
        </form>
    </div>
</div>
<script>
function toggleSection(btn) {
    var body = btn.nextElementSibling;
    var chevron = btn.querySelector('.section-chevron');
    if (body.classList.contains('hidden')) {
        body.classList.remove('hidden');
        chevron.style.transform = 'rotate(0deg)';
    } else {
        body.classList.add('hidden');
        chevron.style.transform = 'rotate(-90deg)';
    }
}

function addLearningPoint() {
    var container = document.getElementById('learning-points');
    var row = document.createElement('div');
    row.className = 'flex items-center gap-2 mb-2 learning-point-row';
    row.innerHTML = '<input type="text" name="learning_points[]" class="flex-1 border-2 border-black px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" style="font-family: \'JetBrains Mono\', monospace;" placeholder="Enter a takeaway">' +
        '<button type="button" onclick="this.parentElement.remove()" class="bg-white text-red-600 px-3 py-2 text-xs font-bold uppercase border-2 border-red-600 hover:bg-red-50" style="font-family: \'JetBrains Mono\', monospace;">Remove</button>';
    container.appendChild(row);
}

(function() {
    var titleInput = document.querySelector('input[name="title"]');
    var slugInput = document.querySelector('input[name="slug"]');
    if (titleInput && slugInput) {
        titleInput.addEventListener('blur', function() {
            if (slugInput.value === '') {
                slugInput.value = titleInput.value.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            }
        });
    }
})();
</script>
{{end}}
